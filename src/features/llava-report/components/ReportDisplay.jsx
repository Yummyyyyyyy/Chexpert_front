import React, { useState, useEffect } from 'react';
import { Card, Space, Typography, Divider, Tag, List, Empty, Tabs } from 'antd';
import {
  FileTextOutlined,
  ClockCircleOutlined,
  CheckCircleOutlined,
  ExperimentOutlined
} from '@ant-design/icons';
import './ReportDisplay.css';

const { Text, Title, Paragraph } = Typography;

/**
 * AIæŠ¥å‘Šå±•ç¤ºç»„ä»¶
 * @param {Object|Array} reports - ç”Ÿæˆçš„æŠ¥å‘Šæ•°æ®ï¼ˆå•ä¸ªå¯¹è±¡æˆ–æ•°ç»„ï¼‰
 */
const ReportDisplay = ({ reports }) => {
  const [activeTab, setActiveTab] = useState('0');

  // ç»Ÿä¸€å¤„ç†ä¸ºæ•°ç»„æ ¼å¼
  const reportList = Array.isArray(reports) ? reports : (reports ? [reports] : []);

  // å½“æŠ¥å‘Šåˆ—è¡¨å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æœ€æ–°çš„æŠ¥å‘Š
  useEffect(() => {
    if (reportList.length > 0) {
      setActiveTab(String(reportList.length - 1));
    }
  }, [reportList.length]);

  if (reportList.length === 0) {
    return (
      <Card className="report-display-card">
        <Empty
          description="No report generated yet"
          image={Empty.PRESENTED_IMAGE_SIMPLE}
        />
      </Card>
    );
  }

  // æ¸²æŸ“å•ä¸ªæŠ¥å‘Šçš„å†…å®¹
  const renderReportContent = (report) => {
    const isLlava7b = report.modelType === 'llava-7b';

    return (
      <div className="report-display-content">
        {/* æŠ¥å‘Šæ ‡é¢˜ */}
        <div className="report-header">
          <Title level={3} style={{ margin: 0, color: '#1e40af' }}>
            {report.title}
          </Title>
          <Space size="small" style={{ marginTop: '8px' }}>
            <ClockCircleOutlined style={{ color: '#6b7280' }} />
            <Text type="secondary">{report.timestamp}</Text>
          </Space>
        </div>

        <Divider />

        {/* è¯Šæ–­ä¿¡æ¯ - ä»…LLaVAæ¨¡å‹æ˜¾ç¤º */}
        {!isLlava7b && report.diagnosis && (
          <>
            <div className="report-section">
              <div className="section-header">
                <Text strong className="section-title">Diagnosis:</Text>
                <Tag color="orange" className="diagnosis-tag">
                  {report.diagnosis}
                </Tag>
              </div>
              <div className="confidence-info">
                <Text type="secondary">
                  Confidence: <strong style={{ color: '#10b981' }}>{report.confidence}%</strong>
                </Text>
              </div>
            </div>
            <Divider />
          </>
        )}

        {/* è¯¦ç»†åˆ†æ */}
        <div className="report-section">
          <Text strong className="section-title">Detailed Analysis:</Text>
          <Paragraph className="analysis-box" style={{ whiteSpace: 'pre-line' }}>
            {report.detailedAnalysis}
          </Paragraph>
        </div>

        {/* åŒ»ç–—å»ºè®® - ä»…LLaVAæ¨¡å‹æ˜¾ç¤º */}
        {!isLlava7b && report.recommendations && report.recommendations.length > 0 && (
          <>
            <Divider />
            <div className="report-section">
              <Text strong className="section-title">Medical Recommendations:</Text>
              <List
                dataSource={report.recommendations}
                renderItem={(item) => (
                  <List.Item className="recommendation-list-item">
                    <CheckCircleOutlined style={{ color: '#10b981', marginRight: '8px' }} />
                    <Text>{item}</Text>
                  </List.Item>
                )}
                className="recommendations-list"
              />
            </div>
          </>
        )}

        {/* è‡ªå®šä¹‰å¤‡æ³¨ */}
        {report.customNotes && (
          <>
            <Divider />
            <div className="report-section">
              <Text strong className="section-title">Custom Notes:</Text>
              <Paragraph className="custom-notes-box">
                {report.customNotes}
              </Paragraph>
            </div>
          </>
        )}

        <Divider />

        {/* æŠ¥å‘Šç”Ÿæˆä¿¡æ¯ */}
        <div className="report-footer">
          <Space>
            <ExperimentOutlined style={{ color: '#8b5cf6' }} />
            <Text type="secondary">
              Generated by: <strong>{report.generatedBy}</strong>
            </Text>
            {report.processingTime && (
              <Text type="secondary">
                | Processing time: <strong>{report.processingTime.toFixed(2)}s</strong>
              </Text>
            )}
          </Space>
        </div>
      </div>
    );
  };

  // å¦‚æœåªæœ‰ä¸€ä¸ªæŠ¥å‘Šï¼Œç›´æ¥æ˜¾ç¤º
  if (reportList.length === 1) {
    return (
      <Card
        title={
          <Space>
            <FileTextOutlined style={{ color: '#059669' }} />
            <span style={{ color: '#047857' }}>Generated Medical Report</span>
          </Space>
        }
        className="report-display-card"
      >
        {renderReportContent(reportList[0])}
      </Card>
    );
  }

  // å¤šä¸ªæŠ¥å‘Šæ—¶ï¼Œä½¿ç”¨Tabsåˆ‡æ¢
  const tabItems = reportList.map((report, index) => ({
    key: String(index),
    label: (
      <span>
        {report.modelType === 'llava-7b' ? 'ğŸ¤– LLAVA-7B' : 'ğŸ¥ LLaVA'}
      </span>
    ),
    children: renderReportContent(report)
  }));

  return (
    <Card
      title={
        <Space>
          <FileTextOutlined style={{ color: '#059669' }} />
          <span style={{ color: '#047857' }}>Generated Medical Reports</span>
        </Space>
      }
      className="report-display-card"
    >
      <Tabs
        activeKey={activeTab}
        onChange={setActiveTab}
        items={tabItems}
        size="large"
        type="card"
      />
    </Card>
  );
};

export default ReportDisplay;
